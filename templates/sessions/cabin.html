{% extends "base.html" %}

{% block title %}Cabine · Sessão {{ session.code }}{% endblock %}

{% block content %}
  <div class="row g-4 align-items-center mb-4">
    <div class="col-lg-8">
      <h1 class="h3 mb-2">Cabine de votação</h1>
      <p class="text-muted mb-0">Selecione um candidato para registrar o voto na sessão <strong>{{ session.code }}</strong>.</p>
    </div>
    <div class="col-lg-4 text-lg-end">
      <a class="btn btn-outline-primary" href="/sessions/{{ session.id }}">Voltar aos detalhes</a>
    </div>
  </div>

  <div class="alert alert-info" id="permit-alert">
    Aguarde o mesário liberar o acesso. O token aparecerá automaticamente quando disponível.
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h2 class="h5 mb-3">Candidatos</h2>
          <form id="vote-form" class="d-grid gap-2">
            {% if candidates %}
              {% for candidate in candidates %}
                <button
                  type="button"
                  class="btn btn-outline-primary btn-lg candidate-button"
                  data-candidate-id="{{ candidate.id }}"
                >
                  {{ candidate.name }}
                  <small class="d-block text-muted">Matrícula {{ candidate.registration }}</small>
                </button>
              {% endfor %}
            {% else %}
              <p class="text-muted">Nenhum candidato cadastrado para esta sessão.</p>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h2 class="h5 mb-3">Status da cabine</h2>
          <dl class="row mb-0">
            <dt class="col-sm-4">Sessão</dt>
            <dd class="col-sm-8">{{ session.code }}</dd>
            <dt class="col-sm-4">Status</dt>
            <dd class="col-sm-8">{{ session.status.value|replace('_', ' ')|title }}</dd>
            <dt class="col-sm-4">Votos restantes</dt>
            <dd class="col-sm-8">{{ session.remaining_votes }}</dd>
          </dl>
          <div class="mt-4">
            <label class="form-label">Token recebido</label>
            <input type="text" class="form-control" id="permit-token" readonly />
          </div>
          <div class="mt-3">
            <button class="btn btn-success w-100" id="confirm-button" disabled>Confirmar voto</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const sessionId = {{ session.id }};
    let selectedCandidate = null;
    let permitToken = null;

    const permitAlert = document.getElementById("permit-alert");
    const permitInput = document.getElementById("permit-token");
    const confirmButton = document.getElementById("confirm-button");
    const candidateButtons = document.querySelectorAll(".candidate-button");

    const socket = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/api/ws/sessions/${sessionId}/cabine`);

    socket.addEventListener("message", (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "vote_permit") {
        permitToken = data.token;
        permitInput.value = permitToken;
        permitAlert.classList.replace("alert-info", "alert-success");
        permitAlert.textContent = "Token recebido! Selecione um candidato e confirme o voto.";
        updateConfirmButton();
      }
    });

    socket.addEventListener("close", () => {
      permitAlert.classList.replace("alert-info", "alert-warning");
      permitAlert.textContent = "Conexão com o servidor perdida. Solicite um novo token ao mesário.";
    });

    candidateButtons.forEach((button) => {
      button.addEventListener("click", () => {
        candidateButtons.forEach((btn) => btn.classList.remove("active", "btn-primary"));
        candidateButtons.forEach((btn) => btn.classList.add("btn-outline-primary"));
        button.classList.remove("btn-outline-primary");
        button.classList.add("btn-primary", "active");
        selectedCandidate = button.dataset.candidateId;
        updateConfirmButton();
      });
    });

    confirmButton.addEventListener("click", async (event) => {
      event.preventDefault();
      if (!selectedCandidate || !permitToken) {
        return;
      }
      confirmButton.disabled = true;
      confirmButton.textContent = "Enviando...";
      function playSuccess() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          const ctx = new AudioCtx();

          const now = ctx.currentTime;

          // 1️⃣ Primeira nota — grave e curta
          const osc1 = ctx.createOscillator();
          const gain1 = ctx.createGain();
          osc1.type = "triangle";
          osc1.frequency.setValueAtTime(440, now); // Lá3
          gain1.gain.setValueAtTime(0.0001, now);
          gain1.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
          gain1.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);
          osc1.connect(gain1).connect(ctx.destination);
          osc1.start(now);
          osc1.stop(now + 0.35);

          // 2️⃣ Segunda nota — aguda e mais longa
          const osc2 = ctx.createOscillator();
          const gain2 = ctx.createGain();
          osc2.type = "square";
          osc2.frequency.setValueAtTime(880, now + 0.25); // sobe uma oitava
          gain2.gain.setValueAtTime(0.0001, now + 0.25);
          gain2.gain.exponentialRampToValueAtTime(0.8, now + 0.3);
          gain2.gain.exponentialRampToValueAtTime(0.0001, now + 0.8);
          osc2.connect(gain2).connect(ctx.destination);
          osc2.start(now + 0.25);
          osc2.stop(now + 0.9);

          // 3️⃣ Um leve “brilho” final
          const osc3 = ctx.createOscillator();
          const gain3 = ctx.createGain();
          osc3.type = "sine";
          osc3.frequency.setValueAtTime(1320, now + 0.8); // harmônico
          gain3.gain.setValueAtTime(0.0001, now + 0.8);
          gain3.gain.exponentialRampToValueAtTime(0.4, now + 0.82);
          gain3.gain.exponentialRampToValueAtTime(0.0001, now + 1.2);
          osc3.connect(gain3).connect(ctx.destination);
          osc3.start(now + 0.8);
          osc3.stop(now + 1.3);

          // Fechar o contexto após 1.5s
          setTimeout(() => {
            ctx.close().catch(() => {});
          }, 1500);
        } catch (err) {
          console.error("Erro ao tocar som de confirmação:", err);
        }
      }
      try {
        const response = await fetch(`/api/sessions/${sessionId}/votes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ candidate_id: Number(selectedCandidate), permit_token: permitToken })
        });
        if (!response.ok) {
          throw new Error("Falha ao registrar o voto.");
        }
        playSuccess();
        permitAlert.classList.replace("alert-success", "alert-info");
        permitAlert.textContent = "Voto registrado com sucesso! Aguarde o próximo token.";
        permitInput.value = "";
        permitToken = null;
        candidateButtons.forEach((btn) => {
          btn.classList.remove("active", "btn-primary");
          btn.classList.add("btn-outline-primary");
        });
        selectedCandidate = null;
      } catch (error) {
        permitAlert.classList.replace("alert-info", "alert-danger");
        permitAlert.textContent = error.message || "Ocorreu um erro ao registrar o voto.";
      } finally {
        confirmButton.disabled = true;
        confirmButton.textContent = "Confirmar voto";
      }
    });

    function updateConfirmButton() {
      confirmButton.disabled = !(selectedCandidate && permitToken);
    }
  </script>
{% endblock %}
